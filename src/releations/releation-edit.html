<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="/plugin/axios/axios.js"></script>
    <script src="/plugin/loadsh/lodash.core.js"></script>
    <script src="/plugin/echarts/echarts.min.js"></script>
    <script src="/plugin/jquery/jquery.js"></script>
    <script src="/plugin/vue/vue.js"></script>

    <!-- 引入 layui.css -->
    <link rel="stylesheet" href="//unpkg.com/layui@2.6.8/dist/css/layui.css">
    <!-- 引入 layui.js -->
    <script src="//unpkg.com/layui@2.6.8/dist/layui.js"></script>

    <title>仪表盘</title>
    <style>
        .layui-container {
            margin: 0px !important;
            width: auto !important;
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="layui-row layui-col-space10">
            <div class="layui-col-md6">
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                    <legend>关系图谱节点编辑</legend>
                </fieldset>
                <form class="layui-form" action="">
                    <div class="layui-form-item">
                        <label class="layui-form-label">节点名称</label>
                        <div class="layui-input-block">
                            <input type="text" name="title" required lay-verify="required" autocomplete="off"
                                placeholder="请输入节点名称" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">X 坐标</label>
                            <div class="layui-input-inline">
                                <input type="text" name="xaixs" autocomplete="off"
                                    class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">Y 坐标</label>
                            <div class="layui-input-inline">
                                <input type="text" name="yaixs" autocomplete="off"
                                    class="layui-input">
                            </div>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <button type="submit" class="layui-btn" lay-submit="" lay-filter="formDemo">立即提交</button>
                        </div>
                    </div>
                </form>
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                    <legend>节点列表</legend>
                </fieldset>
                <div>
                    <table class="layui-table" id="demo" lay-filter="demo"></table>
                </div>
            </div>
            <div class="layui-col-md6">
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                    <legend>图谱预览</legend>
                </fieldset>
                <div style="width: 820px; border: 1px black solid;">
                    <iframe src="/src/releations/releation-map.html" frameborder="0" id="demoAdmin"
                        style="width: 100%; height: 820px; border-radius: 2px;"></iframe>
                </div>
            </div>
        </div>
    </div>

</body>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="/plugin/mustache/mustache.js"></script>
<script src="/static/js/components.js"></script>
<script src="/static/js/comm.js"></script>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
</script>
<script type="x-tmpl-mustache" id="template">
    <select id="node-select">
        {{#list}}
            <option value="{{id}}">{{name}}</option>
        {{/list}}
    </select>
</script>
<script>
    var app = new Vue({
        el: "#app",
        data: {
        }
    })

    var count = 0;

    var graphs = {
        nodes: [],
        links: []
    }

    var tableData = {
        nodes: [],
        links: []
    }

    layui.use(['table', 'form', 'layer'], function () {

        var table = layui.table;

        var form = layui.form;

        //展示已知数据
        table.render({
            elem: '#demo'
            , cellMinWidth: 80
            , cols: [[ //标题栏
                { field: 'id', title: 'ID', sort: true }
                , { field: 'name', title: '节点名称' }
                , { fixed: 'right', title: '操作', toolbar: '#barDemo' }
            ]]
            , page: true
            , data: tableData.nodes
            // ,skin: 'line'
            , even: true
        });
        //监听工具条
        table.on('tool(demo)', function (obj) {
            var data = obj.data;
            layer.msg(JSON.stringify(data));
            var template = document.getElementById('template').innerHTML;
            var rendered = Mustache.render(template, {
                list: table.cache.demo
            });
            layer.open({
                title: '关系配置'
                , content: rendered
                , btn: ['添加', '关闭']
                , yes: function (index, layero) {
                    graphs.links.push({
                        source: data.id,
                        target: Number($("#node-select option:selected").val())
                    });
                    document.getElementById('demoAdmin').contentWindow.location.reload();
                    return false;
                }
                , btn2: function (index, layero) {

                }
            });
        });

        form.on('submit(formDemo)', function (data) {
            layer.msg(JSON.stringify(data.field));
            let x = data.field.xaixs ? Number(data.field.xaixs) : 467;
            let y = data.field.yaixs ? Number(data.field.yaixs) : 208;
            graphs.nodes.push({
                id: count,
                x: x,
                y: y,
                name: data.field.title
            })
            tableData.nodes.push({
                id: count,
                name: data.field.title
            })
            table.reload('demo', {

            });
            count++;
            document.getElementById('demoAdmin').contentWindow.location.reload();
            return false;
        });




    });

</script>

</html>